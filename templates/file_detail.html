{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h3>{{ file.name }}</h3>
    <p class="text-muted mb-0">所属项目：<a href="{{ url_for('project_detail', project_id=file.project_id) }}">{{ file.project.name }}</a></p>
  </div>
  <a class="btn btn-outline-secondary" href="{{ url_for('project_detail', project_id=file.project_id) }}">返回项目</a>
</div>

<div class="row g-3">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header">元数据</div>
      <div class="card-body">
        <form class="row g-3" method="post">
          <input type="hidden" name="action" value="update_metadata">
          <div class="col-md-4">
            <label class="form-label">目录</label>
            <input class="form-control" name="folder" value="{{ file.folder }}">
          </div>
          <div class="col-md-4">
            <label class="form-label">类型</label>
            <input class="form-control" name="file_type" value="{{ file.file_type }}">
          </div>
          <div class="col-md-4">
            <label class="form-label">大小(MB)</label>
            <input class="form-control" name="size_mb" type="number" value="{{ file.size_mb }}">
          </div>
          <div class="col-md-4">
            <label class="form-label">分辨率</label>
            <input class="form-control" name="resolution" value="{{ file.resolution }}">
          </div>
          <div class="col-md-4">
            <label class="form-label">时长(s)</label>
            <input class="form-control" name="duration" type="number" value="{{ file.duration_seconds }}">
          </div>
          <div class="col-md-4">
            <label class="form-label">帧率</label>
            <input class="form-control" name="frame_rate" value="{{ file.frame_rate }}">
          </div>
          <div class="col-md-4">
            <label class="form-label">编码</label>
            <input class="form-control" name="codec" value="{{ file.codec }}">
          </div>
          <div class="col-md-4">
            <label class="form-label">摄影师/机位</label>
            <input class="form-control" name="camera" value="{{ file.camera }}">
          </div>
          <div class="col-md-4">
            <label class="form-label">拍摄地点</label>
            <input class="form-control" name="location" value="{{ file.location }}">
          </div>
          <div class="col-md-4">
            <label class="form-label">分层</label>
            <select class="form-select" name="storage_state">
              {% for tier in ['Hot','Warm','Cold'] %}
                <option value="{{ tier }}" {% if file.storage_state==tier %}selected{% endif %}>{{ tier }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4 form-check">
            <input class="form-check-input" type="checkbox" name="local_available" id="local_available" {% if file.local_available %}checked{% endif %}>
            <label class="form-check-label" for="local_available">NAS 本地可用</label>
          </div>
          <div class="col-md-4 form-check">
            <input class="form-check-input" type="checkbox" name="cloud_synced" id="cloud_synced" {% if file.cloud_synced %}checked{% endif %}>
            <label class="form-check-label" for="cloud_synced">云端已同步</label>
          </div>
          <div class="col-12">
            <label class="form-label">备注/业务元数据</label>
            <textarea class="form-control" name="notes">{{ file.notes }}</textarea>
          </div>
          <div class="col-12 text-end">
            <button class="btn btn-primary">保存</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card mb-3">
      <div class="card-header">标签管理</div>
      <div class="card-body">
        <form class="d-flex gap-2" method="post">
          <input type="hidden" name="action" value="add_tag">
          <input class="form-control" name="tag_name" list="tagOptions" placeholder="输入或选择标签">
          <datalist id="tagOptions">
            {% for tag in all_tags %}
              <option value="{{ tag.name }}">
            {% endfor %}
          </datalist>
          <button class="btn btn-outline-primary">添加</button>
        </form>
        <div class="mt-3">
          {% for tag in file.tags %}
            <form method="post" class="d-inline">
              <input type="hidden" name="action" value="remove_tag">
              <input type="hidden" name="tag_id" value="{{ tag.id }}">
              <span class="badge text-bg-secondary">{{ tag.name }}</span>
              <button class="btn btn-sm btn-link text-danger">移除</button>
            </form>
          {% else %}
            <p class="text-muted">暂无标签</p>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">冷数据访问</div>
      <div class="card-body">
        {% if file.storage_state == 'Cold' and not file.local_available %}
          <p>当前仅保留云端索引，如需使用请发起回迁：</p>
          <form method="post">
            <input type="hidden" name="action" value="restore">
            <button class="btn btn-warning w-100">申请从云端恢复</button>
          </form>
        {% else %}
          <p>文件在 NAS 本地可直接访问。</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
